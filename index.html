<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>acts_as_notifiable_redmine by jbox-web</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/jbox-web/acts_as_notifiable_redmine">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/jbox-web/acts_as_notifiable_redmine/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/jbox-web/acts_as_notifiable_redmine/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>acts_as_notifiable_redmine</h1>
          <p> A gem which makes notifying your Redmine instance easy ;)</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/jbox-web">jbox-web</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <p>This gem is designed to integrate the <a href="http://pusher.com">Pusher Notification System</a> in Redmine but you may use it for other Rails apps ;)</p>

<p>It aims to provide a small DSL for plugin developers who want to use Pusher notifications for their Redmine plugins.</p>

<p>To achieve this, you should install first <a href="https://github.com/jbox-web/redmine_pusher_notifications">Redmine Pusher Notifications</a> which actually install this gem and the <a href="https://github.com/RobinBrouwer/gritter">gritter</a> gem.</p>

<p>Then you just need to declare your channels and events in your <code>init.rb</code> file. That's all!</p>

<h2>
<a name="code-status" class="anchor" href="#code-status"><span class="octicon octicon-link"></span></a>Code status</h2>

<ul>
<li><a href="http://badge.fury.io/rb/acts_as_notifiable_redmine"><img src="https://badge.fury.io/rb/acts_as_notifiable_redmine.svg" alt="Gem Version"></a></li>
<li><a href="https://codeclimate.com/github/jbox-web/acts_as_notifiable_redmine"><img src="https://codeclimate.com/github/jbox-web/acts_as_notifiable_redmine.png" alt="Code Climate"></a></li>
<li><a href="https://gemnasium.com/jbox-web/acts_as_notifiable_redmine"><img src="https://gemnasium.com/jbox-web/acts_as_notifiable_redmine.svg" alt="Dependency Status"></a></li>
</ul><h2>
<a name="requirements" class="anchor" href="#requirements"><span class="octicon octicon-link"></span></a>Requirements</h2>

<ul>
<li>Ruby 1.9.x or 2.0.x</li>
<li>a working <a href="http://www.redmine.org/">Redmine</a> installation</li>
<li>a free account on <a href="http://pusher.com">Pusher</a>
</li>
<li>
<a href="https://github.com/pusher/pusher-gem">pusher</a> gem</li>
</ul><h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>gem install acts_as_notifiable_redmine
</code></pre>

<h2>
<a name="example-usage" class="anchor" href="#example-usage"><span class="octicon octicon-link"></span></a>Example usage</h2>

<p><strong>(1)</strong> First you need to configure you Pusher account :</p>

<pre><code>ActsAsNotifiableRedmine::Notifications.register_courier :pusher do
  app_id    'xxxxx'
  key       'xxxxxxxxxxxxxxxxxxxx'
  secret    'xxxxxxxxxxxxxxxxxxxx'
  encrypted true
end
</code></pre>

<p><strong>Note :</strong> If you're using Redmine Pusher Notifications plugin you don't need to do this. Instead, go to the plugin configuration page.</p>

<p><strong>(2)</strong> Then you need to register your channels and events : each channel can have many events.
It may also have an optional <code>target</code> parameter which can be a string or a Proc.</p>

<pre><code>ActsAsNotifiableRedmine::Notifications.register_channel :channel_test do
  target Proc.new { User.current.login }
  event  :event1, :sticky =&gt; true
  event  :event2, :sticky =&gt; false
  event  :event3
end

ActsAsNotifiableRedmine::Notifications.register_channel :broadcast do
  target 'broadcast'
  event  :event1, :sticky =&gt; true
  event  :event2, :sticky =&gt; false
  event  :event3
end
</code></pre>

<p><strong>Note :</strong> If you're using Redmine Pusher Notifications plugin this is done in <code>init.rb</code> file.</p>

<p><strong>(3)</strong> Once done, you can get the registered channels and events with :</p>

<pre><code>ActsAsNotifiableRedmine::Notifications.channels.each do |name, channel|
  puts "#############"
  puts "Channel :"
  puts "name       : #{channel.name}"
  puts "identifier : #{channel.identifier}"
  puts "token      : #{channel.token}"
  puts "events     :"
  channel.events.each do |event|
    puts "  * #{event.name} (sticky : #{event.sticky?})"
  end
  puts ""
end
</code></pre>

<p>To get the Pusher parameters :</p>

<pre><code>courier = ActsAsNotifiableRedmine::Notifications.courier

puts "#############"
puts "Courier :"
puts "name      : #{courier.name}"
puts "app_id    : #{courier.app_id}"
puts "key       : #{courier.key}"
puts "secret    : #{courier.secret}"
puts "encrypted : #{courier.encrypted}"
</code></pre>

<p><strong>(4)</strong> Finally to send notifications :</p>

<pre><code>ActsAsNotifiableRedmine::Notifications.send_notification([channel.token], event.name, {:title =&gt; 'Hello!', :message =&gt; 'This is a test message !'})
</code></pre>

<p><strong>Note :</strong> The logic to determine wether or not to send a notification is let to the developer. You can easily do this with callbacks :</p>

<pre><code>class Comment &lt; ActiveRecord::Base
    has_many :watchers
    after_create :send_notification

    private

        def send_notification
            channels = []
            watchers.each do |watcher|
                token = '&lt;channel_name&gt;-' + watcher.login
                channels.push(token)
            end
            ActsAsNotifiableRedmine::Notifications.send_notification(channels, &lt;event_name&gt;, {:title =&gt; 'Hello!', :message =&gt; 'This is a test message !'})
        end
end
</code></pre>

<p><strong>(5)</strong> And to display them (put this in the layout) :</p>

<pre><code>&lt;% if User.current.logged? %&gt;

  &lt;%= javascript_tag do %&gt;

    $(document).ready(function() {
      $.extend($.gritter.options, {
        fade_in_speed: 'fast',
        fade_out_speed: 'fast',
        time: 6000,
      });

      $(function() {
        var pusher = new Pusher('&lt;%= ActsAsNotifiableRedmine::Notifications.courier.key %&gt;');

        &lt;% ActsAsNotifiableRedmine::Notifications.channels.each do |name, channel| %&gt;
          var &lt;%= j channel.identifier %&gt; = pusher.subscribe('&lt;%= channel.token %&gt;');

          &lt;%= channel.identifier %&gt;.bind('subscription_error', function(status) {
            $.gritter.add({
              title: 'Pusher : &lt;%= channel.identifier %&gt;',
              text: 'Subscription error'
            });
          });

          &lt;% channel.events.each do |event| %&gt;
            &lt;%= channel.identifier %&gt;.bind('&lt;%= event.name %&gt;', function(data) {
              $.gritter.add({
                title: data.title,
                text: data.message,
                image: data.image,
                sticky: &lt;%= event.sticky? %&gt;,
              });
            });

          &lt;% end %&gt;

        &lt;% end %&gt;

      });
    });
  &lt;% end %&gt;
&lt;% end %&gt;
</code></pre>

<p><strong>Note</strong> : <a href="https://github.com/RobinBrouwer/gritter">gritter</a> is not bundled with this gem. If you're using <a href="https://github.com/jbox-web/redmine_pusher_notifications">Redmine Pusher Notifications</a> this part is already done by the plugin.</p>

<h2>
<a name="copyrights--license" class="anchor" href="#copyrights--license"><span class="octicon octicon-link"></span></a>Copyrights &amp; License</h2>

<p>acts_as_notifiable_redmine is completely free and open source and released under the <a href="https://github.com/jbox-web/acts_as_notifiable_redmine/blob/devel/LICENSE.txt">MIT License</a>.</p>

<p>Copyright (c) 2014 Nicolas Rodriguez (<a href="mailto:nrodriguez@jbox-web.com">nrodriguez@jbox-web.com</a>), JBox Web (<a href="http://www.jbox-web.com">http://www.jbox-web.com</a>) <a href="https://coderwall.com/n-rodriguez"><img src="https://api.coderwall.com/n-rodriguez/endorsecount.png" alt="endorse"></a></p>

<h2>
<a name="contribute" class="anchor" href="#contribute"><span class="octicon octicon-link"></span></a>Contribute</h2>

<p>You can contribute to this plugin in many ways such as :</p>

<ul>
<li>Helping with documentation</li>
<li>Contributing code (features or bugfixes)</li>
<li>Reporting a bug</li>
<li>Submitting translations</li>
</ul><p>You can also donate :)</p>

<p><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=FBT7E7DAVVEEU"><img src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" alt="Donate"></a></p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-36504891-3");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>