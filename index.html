<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>acts_as_notifiable_redmine by jbox-web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">acts_as_notifiable_redmine</h1>
      <h2 class="project-tagline"> A gem which makes notifying your Redmine instance easy ;)</h2>
      <a href="https://github.com/jbox-web/acts_as_notifiable_redmine" class="btn">View on GitHub</a>
      <a href="https://github.com/jbox-web/acts_as_notifiable_redmine/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/jbox-web/acts_as_notifiable_redmine/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="-a-gem-which-makes-notifying-your-redmine-instance-easy-" class="anchor" href="#-a-gem-which-makes-notifying-your-redmine-instance-easy-" aria-hidden="true"><span class="octicon octicon-link"></span></a><img src="https://raw.github.com/jbox-web/acts_as_notifiable_redmine/gh-pages/images/pusher_logo.png" alt="logo"> A gem which makes notifying your Redmine instance easy ;)</h2>

<p><a href="https://github.com/jbox-web/active_use_case/blob/master/LICENSE"><img src="https://img.shields.io/github/license/jbox-web/active_use_case.svg" alt="GitHub license"></a>
<a href="https://rubygems.org/gems/acts_as_notifiable_redmine"><img src="https://img.shields.io/gem/v/acts_as_notifiable_redmine.svg" alt="Gem"></a>
<a href="https://rubygems.org/gems/acts_as_notifiable_redmine/versions/0.1.1"><img src="https://img.shields.io/gem/dv/acts_as_notifiable_redmine/0.1.1.svg" alt="Gem"></a>
<a href="https://codeclimate.com/github/jbox-web/acts_as_notifiable_redmine"><img src="https://codeclimate.com/github/jbox-web/acts_as_notifiable_redmine.png" alt="Code Climate"></a>
<a href="https://gemnasium.com/jbox-web/acts_as_notifiable_redmine"><img src="https://gemnasium.com/jbox-web/acts_as_notifiable_redmine.svg" alt="Dependency Status"></a></p>

<p>This gem is designed to integrate the <a href="http://pusher.com">Pusher Notification System</a> in Redmine but you may use it for other Rails apps ;)</p>

<p>It aims to provide a small DSL for plugin developers who want to use Pusher notifications for their Redmine plugins.</p>

<p>To achieve this, you should install first <a href="https://github.com/jbox-web/redmine_pusher_notifications">Redmine Pusher Notifications</a> which actually install this gem and the <a href="https://github.com/RobinBrouwer/gritter">gritter</a> gem.</p>

<p>Then you just need to declare your channels and events in your <code>init.rb</code> file. That's all!</p>

<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Requirements</h2>

<ul>
<li>Ruby 1.9.x or 2.0.x</li>
<li>a working <a href="http://www.redmine.org/">Redmine</a> installation</li>
<li>a free account on <a href="http://pusher.com">Pusher</a>
</li>
<li>
<a href="https://github.com/pusher/pusher-gem">pusher</a> gem</li>
</ul>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<div class="highlight highlight-ruby"><pre><span class="pl-k">gem</span> install acts_as_notifiable_redmine</pre></div>

<h2>
<a id="example-usage" class="anchor" href="#example-usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example usage</h2>

<p><strong>(1)</strong> First you need to configure you Pusher account :</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.register_courier <span class="pl-c1">:pusher</span> <span class="pl-k">do</span>
  app_id    <span class="pl-s"><span class="pl-pds">'</span>xxxxx<span class="pl-pds">'</span></span>
  key       <span class="pl-s"><span class="pl-pds">'</span>xxxxxxxxxxxxxxxxxxxx<span class="pl-pds">'</span></span>
  secret    <span class="pl-s"><span class="pl-pds">'</span>xxxxxxxxxxxxxxxxxxxx<span class="pl-pds">'</span></span>
  encrypted <span class="pl-c1">true</span>
<span class="pl-k">end</span></pre></div>

<p><strong>Note :</strong> If you're using Redmine Pusher Notifications plugin you don't need to do this. Instead, go to the plugin configuration page.</p>

<p><strong>(2)</strong> Then you need to register your channels and events : each channel can have many events.
It may also have an optional <code>target</code> parameter which can be a string or a Proc.</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.register_channel <span class="pl-c1">:channel_test</span> <span class="pl-k">do</span>
  target <span class="pl-c1">Proc</span>.<span class="pl-k">new</span> { <span class="pl-c1">User</span>.current.login }
  event  <span class="pl-c1">:event1</span>, <span class="pl-c1">:sticky</span> =&gt; <span class="pl-c1">true</span>
  event  <span class="pl-c1">:event2</span>, <span class="pl-c1">:sticky</span> =&gt; <span class="pl-c1">false</span>
  event  <span class="pl-c1">:event3</span>
<span class="pl-k">end</span>

<span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.register_channel <span class="pl-c1">:broadcast</span> <span class="pl-k">do</span>
  target <span class="pl-s"><span class="pl-pds">'</span>broadcast<span class="pl-pds">'</span></span>
  event  <span class="pl-c1">:event1</span>, <span class="pl-c1">:sticky</span> =&gt; <span class="pl-c1">true</span>
  event  <span class="pl-c1">:event2</span>, <span class="pl-c1">:sticky</span> =&gt; <span class="pl-c1">false</span>
  event  <span class="pl-c1">:event3</span>
<span class="pl-k">end</span></pre></div>

<p><strong>Note :</strong> If you're using Redmine Pusher Notifications plugin this is done in <code>init.rb</code> file.</p>

<p><strong>(3)</strong> Once done, you can get the registered channels and events with :</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.channels.each <span class="pl-k">do </span>|<span class="pl-smi">name</span>, <span class="pl-smi">channel</span>|
  puts <span class="pl-s"><span class="pl-pds">"</span>#############<span class="pl-pds">"</span></span>
  puts <span class="pl-s"><span class="pl-pds">"</span>Channel :<span class="pl-pds">"</span></span>
  puts <span class="pl-s"><span class="pl-pds">"</span>name       : <span class="pl-pse">#{</span><span class="pl-s1">channel.name</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
  puts <span class="pl-s"><span class="pl-pds">"</span>identifier : <span class="pl-pse">#{</span><span class="pl-s1">channel.identifier</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
  puts <span class="pl-s"><span class="pl-pds">"</span>token      : <span class="pl-pse">#{</span><span class="pl-s1">channel.token</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
  puts <span class="pl-s"><span class="pl-pds">"</span>events     :<span class="pl-pds">"</span></span>
  channel.events.each <span class="pl-k">do </span>|<span class="pl-smi">event</span>|
    puts <span class="pl-s"><span class="pl-pds">"</span>  * <span class="pl-pse">#{</span><span class="pl-s1">event.name</span><span class="pl-pse"><span class="pl-s1">}</span></span> (sticky : <span class="pl-pse">#{</span><span class="pl-s1">event.sticky?</span><span class="pl-pse"><span class="pl-s1">}</span></span>)<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>
  puts <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
<span class="pl-k">end</span></pre></div>

<p>To get the Pusher parameters :</p>

<div class="highlight highlight-ruby"><pre>courier <span class="pl-k">=</span> <span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.courier

puts <span class="pl-s"><span class="pl-pds">"</span>#############<span class="pl-pds">"</span></span>
puts <span class="pl-s"><span class="pl-pds">"</span>Courier :<span class="pl-pds">"</span></span>
puts <span class="pl-s"><span class="pl-pds">"</span>name      : <span class="pl-pse">#{</span><span class="pl-s1">courier.name</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
puts <span class="pl-s"><span class="pl-pds">"</span>app_id    : <span class="pl-pse">#{</span><span class="pl-s1">courier.app_id</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
puts <span class="pl-s"><span class="pl-pds">"</span>key       : <span class="pl-pse">#{</span><span class="pl-s1">courier.key</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
puts <span class="pl-s"><span class="pl-pds">"</span>secret    : <span class="pl-pse">#{</span><span class="pl-s1">courier.secret</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
puts <span class="pl-s"><span class="pl-pds">"</span>encrypted : <span class="pl-pse">#{</span><span class="pl-s1">courier.encrypted</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span></pre></div>

<p><strong>(4)</strong> Finally to send notifications :</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.send_notification([channel.token], event.name, {<span class="pl-c1">:title</span> =&gt; <span class="pl-s"><span class="pl-pds">'</span>Hello!<span class="pl-pds">'</span></span>, <span class="pl-c1">:message</span> =&gt; <span class="pl-s"><span class="pl-pds">'</span>This is a test message !<span class="pl-pds">'</span></span>})</pre></div>

<p><strong>Note :</strong> The logic to determine wether or not to send a notification is let to the developer. You can easily do this with callbacks :</p>

<div class="highlight highlight-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Comment<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_many <span class="pl-c1">:watchers</span>
  after_create <span class="pl-c1">:send_notification</span>

  <span class="pl-k">private</span>

    <span class="pl-k">def</span> <span class="pl-en">send_notification</span>
      channels <span class="pl-k">=</span> []
      watchers.each <span class="pl-k">do </span>|<span class="pl-smi">watcher</span>|
        token <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;channel_name&gt;-<span class="pl-pds">'</span></span> <span class="pl-k">+</span> watcher.login
        channels.push(token)
      <span class="pl-k">end</span>
      <span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.send_notification(channels, <span class="pl-k">&lt;</span>event_name<span class="pl-k">&gt;</span>, {<span class="pl-c1">:title</span> =&gt; <span class="pl-s"><span class="pl-pds">'</span>Hello!<span class="pl-pds">'</span></span>, <span class="pl-c1">:message</span> =&gt; <span class="pl-s"><span class="pl-pds">'</span>This is a test message !<span class="pl-pds">'</span></span>})
    <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p><strong>(5)</strong> And to display them (put this in the layout) :</p>

<div class="highlight highlight-ruby"><pre><span class="pl-k">&lt;</span><span class="pl-k">%</span> <span class="pl-k">if</span> <span class="pl-c1">User</span>.current.logged? <span class="pl-s"><span class="pl-pds">%&gt;</span></span>
<span class="pl-s"></span>
<span class="pl-s">  &lt;%= javascript_tag do %<span class="pl-pds">&gt;</span></span>

    $(document).ready(function() {
      <span class="pl-smi">$.</span><span class="pl-k">extend</span>(<span class="pl-smi">$.</span>gritter.options, {
        <span class="pl-c1">fade_in_speed:</span> <span class="pl-s"><span class="pl-pds">'</span>fast<span class="pl-pds">'</span></span>,
        <span class="pl-c1">fade_out_speed:</span> <span class="pl-s"><span class="pl-pds">'</span>fast<span class="pl-pds">'</span></span>,
        <span class="pl-c1">time:</span> <span class="pl-c1">6000</span>,
      });

      $(function() {
        var pusher <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Pusher</span>(<span class="pl-s"><span class="pl-pds">'</span>&lt;%= ActsAsNotifiableRedmine::Notifications.courier.key %&gt;<span class="pl-pds">'</span></span>);

        <span class="pl-k">&lt;</span><span class="pl-k">%</span> <span class="pl-c1">ActsAsNotifiableRedmine</span>::<span class="pl-c1">Notifications</span>.channels.each <span class="pl-k">do </span>|<span class="pl-smi">name</span>, <span class="pl-smi">channel</span>| <span class="pl-s"><span class="pl-pds">%&gt;</span></span>
<span class="pl-s">          var &lt;%= j channel.identifier %<span class="pl-pds">&gt;</span></span> <span class="pl-k">=</span> pusher.subscribe(<span class="pl-s"><span class="pl-pds">'</span>&lt;%= channel.token %&gt;<span class="pl-pds">'</span></span>);

          <span class="pl-k">&lt;</span><span class="pl-k">%=</span> channel.identifier <span class="pl-s"><span class="pl-pds">%&gt;</span>.bind('subscription_error', function(status) {</span>
<span class="pl-s">            $.gritter.add({</span>
<span class="pl-s">              title: 'Pusher : &lt;%= channel.identifier %<span class="pl-pds">&gt;</span></span><span class="pl-s"><span class="pl-pds">'</span>,</span>
<span class="pl-s">              text: <span class="pl-pds">'</span></span><span class="pl-c1">Subscription</span> error<span class="pl-s"><span class="pl-pds">'</span></span>
<span class="pl-s">            });</span>
<span class="pl-s">          });</span>
<span class="pl-s"></span>
<span class="pl-s">          &lt;% channel.events.each do |event| %&gt;</span>
<span class="pl-s">            &lt;%= channel.identifier %&gt;.bind(<span class="pl-pds">'</span></span><span class="pl-k">&lt;</span><span class="pl-k">%=</span> event.name <span class="pl-s"><span class="pl-pds">%&gt;</span>', function(data) {</span>
<span class="pl-s">              $.gritter.add({</span>
<span class="pl-s">                title: data.title,</span>
<span class="pl-s">                text: data.message,</span>
<span class="pl-s">                image: data.image,</span>
<span class="pl-s">                sticky: &lt;%= event.sticky? %<span class="pl-pds">&gt;</span></span>,
              });
            });

          <span class="pl-k">&lt;</span><span class="pl-k">%</span> <span class="pl-k">end</span> <span class="pl-s"><span class="pl-pds">%&gt;</span></span>
<span class="pl-s"></span>
<span class="pl-s">        &lt;% end %<span class="pl-pds">&gt;</span></span>

      });
    });
  <span class="pl-k">&lt;</span><span class="pl-k">%</span> <span class="pl-k">end</span> <span class="pl-s"><span class="pl-pds">%&gt;</span></span>
<span class="pl-s">&lt;% end %<span class="pl-pds">&gt;</span></span></pre></div>

<p><strong>Note</strong> : <a href="https://github.com/RobinBrouwer/gritter">gritter</a> is not bundled with this gem. If you're using <a href="https://github.com/jbox-web/redmine_pusher_notifications">Redmine Pusher Notifications</a> this part is already done by the plugin.</p>

<h2>
<a id="contribute" class="anchor" href="#contribute" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contribute</h2>

<p>You can contribute to this plugin in many ways such as :</p>

<ul>
<li>Helping with documentation</li>
<li>Contributing code (features or bugfixes)</li>
<li>Reporting a bug</li>
<li>Submitting translations</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jbox-web/acts_as_notifiable_redmine">acts_as_notifiable_redmine</a> is maintained by <a href="https://github.com/jbox-web">jbox-web</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-36504891-3");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
